<app-navbar></app-navbar>

<div class="profile-container">
  
  <div *ngIf="user$ | async as user; else loading" class="profile-card">
    
    <h2>¡Hola de nuevo, {{ user.nombre }}!</h2>
    
    <span *ngIf="user.administrador === 1" style="background: #2d3748; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; vertical-align: middle;">ADMINISTRADOR</span>
    
    <p class="status-message">Bienvenido a tu panel de control</p>

    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

    <div *ngIf="!isEditing" class="profile-details">
      <h3>Tus Datos Personales</h3>
      <div class="detail-item"><strong>Nombre:</strong><span>{{ user.nombre }}</span></div>
      <div class="detail-item"><strong>Email:</strong><span>{{ user.email }}</span></div>
      <div class="detail-item"><strong>Dirección:</strong><span>{{ user.direccion }}</span></div>
      
      <div class="action-buttons">
        <button class="edit-btn" (click)="enableEdit()">Editar Perfil</button>
        <button class="delete-btn" (click)="onDelete()">Eliminar Cuenta</button>
        
        <a *ngIf="user.administrador === 1" routerLink="/admin-products" class="edit-btn" style="background-color: #2d3748 !important; border-color: #1a202c; text-decoration: none; text-align: center;">
            Gestionar Productos
        </a>
      </div>
    </div>
    
    <div *ngIf="isEditing" class="edit-form-panel">
         <h3>Editar Datos</h3>
         <form [formGroup]="editForm" (ngSubmit)="onUpdate()">
            <div class="form-group"><label>Nombre</label><input type="text" formControlName="nombre"></div>
             <div class="form-group"><label>Email</label><input type="email" formControlName="email"></div>
             <div class="form-group"><label>Dirección</label><input type="text" formControlName="direccion"></div>
             <div class="action-buttons">
                <button type="submit" class="submit-btn" [disabled]="editForm.invalid">Guardar</button>
                <button type="button" class="cancel-btn" (click)="cancelEdit()">Cancelar</button>
             </div>
         </form>
    </div>

    <div class="order-history" *ngIf="user.administrador !== 1">
      <h3>Historial de Pedidos</h3>
      <p *ngIf="orderHistory.length === 0" class="empty-history">Aún no tienes pedidos registrados.</p>
      
      <div *ngIf="orderHistory.length > 0" class="orders-list">
          <div *ngFor="let order of orderHistory" class="order-card">
              <div class="order-header">
                  <span class="order-date"> {{ order.fecha | date:'mediumDate' }}</span>
                  <span class="order-status" [class.completed]="order.estado === 'COMPLETADO'">{{ order.estado }}</span>
                  <span class="order-total">Total: ${{ order.total | number:'1.2-2' }}</span>
              </div>
              <div class="order-items">
                  <div *ngFor="let item of order.detalles" class="order-item-detail">
                      <img [src]="item.producto_imagen" alt="prod" class="mini-img" *ngIf="item.producto_imagen">
                      <div class="item-info">
                          <span class="item-name">{{ item.producto_nombre }}</span>
                          <span class="item-qty">x{{ item.cantidad }}</span>
                      </div>
                      <span class="item-price">${{ item.precio_unidad | number:'1.2-2' }}</span>
                  </div>
              </div>
          </div>
      </div>
    </div>

  </div>
  <ng-template #loading><p style="text-align: center;">Cargando perfil...</p></ng-template>
</div>